# Mise Integration Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Install mise (Rust-based runtime version manager) via cargo and configure it to install Node.js LTS globally, with Fish shell integration and a chezmoi-managed global tool config.

**Architecture:** Four independent changes — add `mise` to cargo packages, create the global tool config, add a `run_onchange` install script that reruns when the config changes, and add Fish shell init. No platform-specific logic needed since mise is cross-platform.

**Tech Stack:** chezmoi Go templates, Fish shell, Rust/cargo, mise

---

### Task 1: Add mise to cargo packages

**Files:**
- Modify: `home/.chezmoidata/packages.yaml`

**Step 1: Read current file**

```bash
cat home/.chezmoidata/packages.yaml
```

Expected: `packages.cargo` list starts with `atuin`.

**Step 2: Add `mise` in alphabetical order (between `git-cliff` and `ripgrep`)**

```yaml
  cargo:
    - atuin
    - bat
    - cargo-update
    - difftastic
    - eza
    - git-cliff
    - mise
    - ripgrep
    - starship
    - topgrade
```

**Step 3: Verify the cargo install template renders with mise**

```bash
chezmoi execute-template < home/.chezmoiscripts/run_onchange_after_20-install-cargo-packages.sh.tmpl 2>/dev/null | grep mise
```

Expected output: `cargo install --locked mise`

**Step 4: Commit**

```bash
git add home/.chezmoidata/packages.yaml
git commit -m "feat: add mise to cargo packages"
```

---

### Task 2: Create mise global tool config

**Files:**
- Create: `home/dot_config/mise/config.toml`

**Step 1: Create the file**

```toml
[tools]
node = "lts"
```

**Step 2: Verify chezmoi would apply it**

```bash
chezmoi apply --dry-run 2>&1 | grep mise
```

Expected: shows `~/.config/mise/config.toml` would be created.

**Step 3: Apply**

```bash
chezmoi apply
```

**Step 4: Verify**

```bash
cat ~/.config/mise/config.toml
```

Expected: matches the content above exactly.

**Step 5: Commit**

```bash
git add home/dot_config/mise/config.toml
git commit -m "feat: add mise global tool config with node lts"
```

---

### Task 3: Create mise tool install script

**Files:**
- Create: `home/.chezmoiscripts/run_onchange_after_21-install-mise-tools.sh.tmpl`

**Context:**
- `run_onchange_after_21` runs after `run_onchange_after_20` (cargo packages) — mise will be installed first.
- The script embeds the mise config content as a comment (same trick as `run_onchange_after_20-install-cargo-packages.sh.tmpl` which uses `# Packages: {{ .packages.cargo | join ", " }}`). This means whenever `config.toml` changes (e.g. adding Python), the rendered script content changes and chezmoi reruns it automatically.
- `mise install` reads `~/.config/mise/config.toml` and installs any missing tools. It is idempotent.

**Step 1: Create the script**

```bash
#!/bin/bash
set -eufo pipefail

# Tools config: {{ include "dot_config/mise/config.toml" | trim }}

if ! command -v mise >/dev/null 2>&1; then
    # shellcheck source=/dev/null
    source "${HOME}/.cargo/env"
fi

mise install
```

**Step 2: Verify the template renders correctly**

```bash
chezmoi execute-template < home/.chezmoiscripts/run_onchange_after_21-install-mise-tools.sh.tmpl 2>/dev/null
```

Expected: rendered script shows the config content in the comment and `mise install` at the end:
```
#!/bin/bash
set -eufo pipefail

# Tools config: [tools]
# node = "lts"

...
mise install
```

**Step 3: Verify chezmoi apply would run the script**

```bash
chezmoi apply --dry-run 2>&1 | grep mise
```

Expected: shows the install script would be run.

**Step 4: Apply (installs Node.js LTS — takes a moment)**

```bash
chezmoi apply
```

Expected: mise downloads and installs the Node.js LTS binary.

**Step 5: Verify node is available via mise**

```bash
mise exec -- node --version
```

Expected: prints a Node.js LTS version (e.g. `v22.x.x`).

**Step 6: Commit**

```bash
git add home/.chezmoiscripts/run_onchange_after_21-install-mise-tools.sh.tmpl
git commit -m "feat: add mise tool install script"
```

---

### Task 4: Add Fish shell integration

**Files:**
- Create: `home/dot_config/fish/conf.d/mise.fish`

**Context:** The Fish `conf.d/` directory is loaded alphabetically. Other init files follow the same pattern: check `command -q <tool>` before sourcing. `mise activate fish` sets up PATH and shims for all mise-managed tools.

**Step 1: Create the file**

```fish
if command -q mise
    mise activate fish | source
end
```

**Step 2: Apply and verify**

```bash
chezmoi apply
cat ~/.config/fish/conf.d/mise.fish
```

Expected: file exists with the content above.

**Step 3: Verify node is on PATH in a new Fish shell**

```bash
fish -c "node --version"
```

Expected: prints the Node.js LTS version (e.g. `v22.x.x`).

**Step 4: Commit and push**

```bash
git add home/dot_config/fish/conf.d/mise.fish
git commit -m "feat: add mise Fish shell integration"
git pull && git push
```
