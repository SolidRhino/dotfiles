# Atuin Integration Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Install Atuin shell history sync via chezmoi on macOS and Linux, with config and automatic 1Password login.

**Architecture:** Four independent changes — add `atuin` to cargo packages, create the config file, add Fish shell init, and add a `run_once` login script that reads credentials from 1Password at apply time using `onepasswordRead`. No daemon.

**Tech Stack:** chezmoi Go templates, `onepasswordRead`, Fish shell, Rust/cargo

---

### Task 1: Add atuin to cargo packages

**Files:**
- Modify: `home/.chezmoidata/packages.yaml`

**Step 1: Read current file**

```bash
cat home/.chezmoidata/packages.yaml
```

Expected: `packages.cargo` list starts with `bat`.

**Step 2: Add `atuin` as the first entry in `packages.cargo` (alphabetical)**

```yaml
  cargo:
    - atuin
    - bat
    - cargo-update
    - difftastic
    - eza
    - git-cliff
    - ripgrep
    - starship
    - topgrade
```

**Step 3: Verify the cargo install template renders with atuin**

```bash
chezmoi execute-template < home/.chezmoiscripts/run_onchange_after_20-install-cargo-packages.sh.tmpl 2>/dev/null | grep atuin
```

Expected output: `cargo install --locked atuin`

**Step 4: Commit**

```bash
git add home/.chezmoidata/packages.yaml
git commit -m "feat: add atuin to cargo packages"
```

---

### Task 2: Create atuin config

**Files:**
- Create: `home/dot_config/atuin/config.toml`

**Step 1: Create the directory and file**

```toml
[sync]
auto_sync = true
sync_frequency = "0"

[history]
filter_mode = "host"

[keys]
dialect = "uk"
```

**Step 2: Verify chezmoi applies it cleanly**

```bash
chezmoi apply --dry-run 2>&1 | grep atuin
```

Expected: shows `~/.config/atuin/config.toml` would be created.

**Step 3: Apply**

```bash
chezmoi apply
```

**Step 4: Verify**

```bash
cat ~/.config/atuin/config.toml
```

Expected: matches the content above exactly.

**Step 5: Commit**

```bash
git add home/dot_config/atuin/config.toml
git commit -m "feat: add atuin config"
```

---

### Task 3: Add Fish shell integration

**Files:**
- Create: `home/dot_config/fish/conf.d/atuin.fish`

**Context:** The Fish `conf.d/` directory is loaded alphabetically on shell startup. Other init files in this directory follow the same pattern: check `command -q <tool>` before sourcing, to fail gracefully if not installed.

**Step 1: Create the file**

```fish
if command -q atuin
    atuin init fish | source
end
```

**Step 2: Apply and verify**

```bash
chezmoi apply
cat ~/.config/fish/conf.d/atuin.fish
```

Expected: file exists with the content above.

**Step 3: Commit**

```bash
git add home/dot_config/fish/conf.d/atuin.fish
git commit -m "feat: add atuin Fish shell integration"
```

---

### Task 4: Create 1Password login script

**Files:**
- Create: `home/.chezmoiscripts/run_once_after_35-login-atuin.sh.tmpl`

**Context:**
- `run_once_after_35` runs after `run_onchange_after_20` (cargo packages) — so atuin will be installed first.
- `onepasswordRead` is a chezmoi template function that reads from 1Password **at apply time** and bakes the value into the rendered script. This is consistent with how `claude.fish.tmpl` works in this repo.
- The script is guarded to only run on macOS and personal non-headless Linux (same pattern as SSH signing config in `dot_gitconfig.tmpl`).
- Idempotent: skips if `~/.local/share/atuin/session` already exists.

**Step 1: Create the script**

```bash
{{ if or (eq .chezmoi.os "darwin") (and (eq .chezmoi.os "linux") .personal (not .headless)) -}}
#!/bin/bash
set -eufo pipefail

# Skip if already logged in
if [[ -f "${HOME}/.local/share/atuin/session" ]]; then
    echo "atuin: already logged in, skipping"
    exit 0
fi

if ! command -v atuin >/dev/null 2>&1; then
    # shellcheck source=/dev/null
    source "${HOME}/.cargo/env"
fi

atuin login \
    -u "{{ onepasswordRead "op://Private/Atuin/CLI/gebruikersnaam" }}" \
    -p "{{ onepasswordRead "op://Private/Atuin/CLI/wachtwoord" }}" \
    -k "{{ onepasswordRead "op://Private/Atuin/CLI/key" }}"
{{ end -}}
```

**Step 2: Verify the template renders correctly (without running it)**

```bash
chezmoi execute-template < home/.chezmoiscripts/run_once_after_35-login-atuin.sh.tmpl 2>/dev/null | head -5
```

Expected: starts with `#!/bin/bash` (confirms the `if` condition is met on macOS).

**Step 3: Verify chezmoi apply would run the script**

```bash
chezmoi apply --dry-run 2>&1 | grep atuin
```

Expected: shows the login script would be run.

**Step 4: Apply (requires 1Password to be unlocked)**

```bash
chezmoi apply
```

Expected: either "atuin: already logged in, skipping" or a successful login.

**Step 5: Commit and push**

```bash
git add home/.chezmoiscripts/run_once_after_35-login-atuin.sh.tmpl
git commit -m "feat: add atuin 1Password login script"
git pull && git push
```
